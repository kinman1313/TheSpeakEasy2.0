#!/usr/bin/env node

/**
 * Complete Firebase Diagnostic & Fix Tool
 * Checks all Firebase services and provides fixes for each issue
 */

require('dotenv').config()

console.log('üîß COMPLETE FIREBASE DIAGNOSTIC & FIX TOOL\n')

const projectId = process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID
console.log(`üìã Project: ${projectId}\n`)

console.log('üö® CRITICAL ISSUES DETECTED:')
console.log('1. ‚ùå Only sender sees messages (Firestore listeners)')
console.log('2. ‚ùå Room creation fails (API authentication)')
console.log('3. ‚ùå Voice/video calls fail (Realtime DB rules)')
console.log('4. ‚ùå Voice messages fail (Storage rules)')

console.log('\nüî• FIRESTORE FIXES:')
console.log('='.repeat(50))
console.log('Go to: https://console.firebase.google.com/')
console.log(`Select: ${projectId} ‚Üí Firestore Database ‚Üí Rules`)
console.log('Replace rules with:')
console.log('')
console.log('rules_version = \'2\';')
console.log('service cloud.firestore {')
console.log('  match /databases/{database}/documents {')
console.log('    // Temporarily allow all authenticated users')
console.log('    match /{document=**} {')
console.log('      allow read, write: if request.auth != null;')
console.log('    }')
console.log('  }')
console.log('}')
console.log('')
console.log('‚ö†Ô∏è  Click PUBLISH and wait 2 minutes!')

console.log('\nüíæ FIREBASE STORAGE FIXES:')
console.log('='.repeat(50))
console.log('Go to: Firebase Console ‚Üí Storage ‚Üí Rules')
console.log('Replace rules with:')
console.log('')
console.log('rules_version = \'2\';')
console.log('service firebase.storage {')
console.log('  match /b/{bucket}/o {')
console.log('    match /{allPaths=**} {')
console.log('      allow read, write: if request.auth != null;')
console.log('    }')
console.log('  }')
console.log('}')
console.log('')
console.log('‚ö†Ô∏è  Click PUBLISH!')

console.log('\n‚ö° REALTIME DATABASE FIXES:')
console.log('='.repeat(50))
console.log('Go to: Firebase Console ‚Üí Realtime Database ‚Üí Rules')
console.log('Replace rules with:')
console.log('')
console.log('{')
console.log('  "rules": {')
console.log('    ".read": "auth != null",')
console.log('    ".write": "auth != null"')
console.log('  }')
console.log('}')
console.log('')
console.log('‚ö†Ô∏è  Click PUBLISH!')

console.log('\nüß™ TESTING STEPS:')
console.log('1. Publish ALL three rule sets above')
console.log('2. Wait 2-3 minutes for rules to propagate')
console.log('3. Clear browser cache completely')
console.log('4. Restart your dev server')
console.log('5. Test each feature:')
console.log('   ‚Ä¢ Login')
console.log('   ‚Ä¢ Create a room')
console.log('   ‚Ä¢ Send messages (should see real-time)')
console.log('   ‚Ä¢ Send voice message')
console.log('   ‚Ä¢ Try video call')

console.log('\nüîç BROWSER CONSOLE TESTS:')
console.log('After login, run these in browser console:')
console.log('')
console.log('// Test auth')
console.log('firebase.auth().currentUser')
console.log('')
console.log('// Test Firestore')
console.log('firebase.firestore().collection("test").add({test: "data"})')
console.log('')
console.log('// Test Storage')
console.log('firebase.storage().ref("test").putString("test")')

console.log('\n‚è∞ TIMELINE:')
console.log('‚Ä¢ Rules publish: ~30 seconds')
console.log('‚Ä¢ Rules propagate: ~2 minutes')
console.log('‚Ä¢ Cache clear: Immediate')
console.log('‚Ä¢ Testing: After 3 minutes total')

console.log('\nüéØ SUCCESS CRITERIA:')
console.log('‚úÖ Room creation works')
console.log('‚úÖ Messages appear for all users in real-time')
console.log('‚úÖ Voice messages upload and play')
console.log('‚úÖ Video calls connect successfully')
console.log('‚úÖ No 400/403 errors in console')

console.log('\nüÜò IF STILL BROKEN:')
console.log('1. Check Firebase billing (Blaze plan required for some features)')
console.log('2. Verify project ID matches in all configs')
console.log('3. Check API quotas in Firebase Console')
console.log('4. Ensure all Firebase services are enabled')

console.log('\nüöÄ NEXT: Run "npm run dev" after publishing rules!') 